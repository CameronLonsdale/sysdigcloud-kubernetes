---
apiVersion: v1
kind: Secret
metadata:
  name: sysdigcloud-pull-secret
  namespace: {{ .namespace }}
data:
  .dockerconfigjson: "{{ .pullSecret }}"
type: kubernetes.io/dockerconfigjson
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: sysdigcloud-config
  namespace: {{ .namespace }}
data:
  #License
  sysdigcloud.license: "{{ .license}}"
  #endpoints
  elasticsearch.url: "{{ .elasticsearchUrl }}"
  redis.endpoint: "{{ .redisEndpoint }}"
  cassandra.endpoint: "{{ .cassandraEndpoint }}"
  mysql.endpoint: "{{ .mysqlEndpoint}}"
  collector.endpoint: "{{ .collectorEndpoint }}"
  collector.port: "{{ .collectorPort }}"
  api.url: "{{ .apiUrl }}"
  #passwords
  sysdigcloud.default.user: "{{ .defaultUser }}"
  sysdigcloud.default.user.password: "{{ .defaultUserPassword }}"
  cassandra.user: "{{ .cassandraUser }}"
  cassandra.password: "{{ .cassandraPassword }}"
  redis.password: "{{ .redisPassword }}"
  mysql.user: "{{ .mysqlUser }}"
  mysql.password: "{{ .mysqlPassword }}"
  mysql.root.user: "{{ .mysqlRootUser }}"
  mysql.root.password: "{{ .mysqlRootPassword }}"
  #jvm options
  cassandra.jvm.options: "{{ .cassandraJvmOptions }}"
  elasticsearch.jvm.options: "{{ .elasticsearchJvmOptions }}"
  sysdigcloud.jvm.options: "{{ .jvmOptions }}"
  #elasticsearch
  elasticsearch.service: "{{ .elasticsearchService }}"
  elasticsearch.cluster.name: "{{ .elasticsearchClusterName }}"
  elasticsearch.minimum.master.nodes: "{{ .elasticsearchMinimumMasterNodes }}"
  #Cassandra
  cassandra.cluster.name: "{{ .cassandraClusterName }}"
  cassandra.service: "{{ .cassandraService }}"
  cassandra.seeds: "{{ .cassandraSeeds }}.{{ .cassandraService }}.{{ .namespace }}.svc.cluster.local"
  cassandra.seed.provider: "{{ .cassandraSeedProvider }}"
  cassandra.endpoint.snitch: "{{ .cassandraEndpointSnitch }}"
  cassandra.start.rpc: "{{ .cassandraStartRpc }}"
  cassandra.secure: "{{ .cassandraSecure }}"
  cassandra.ssl.enabled: "{{ .cassandraSslEnabled }}"
  cassandra.ssl.ciphers: "{{ .cassandraSslCiphers }}"
  cassandra.port: "{{ .cassandraPort }}"
  cassandra.replication.factor: "{{ .cassandraReplicationFactor }}"
  sysdigcloud.captures.cassandra.storage: "{{ .capturesCassandraStorage }}"
  #smtp
  smtp.server: "{{ .smtpServer }}"
  smtp.server.port: "{{ .smtpServerPort }}"
  smtp.user: "{{ .smtpUser }}"
  smtp.password: "{{ .smtpPassword }}"
  smtp.tls: "{{ .smtpTls }}"
  smtp.ssl: "{{ .smtpSsl }}"
  smtp.from.address: "{{ .smtpFromAddress }}"
  #logging
  sysdigcloud.logging.stdout: "{{ .loggingStdout }}"
  #Auth and LDAP
  sysdigcloud.restrict.password.login: "{{ .restrictPasswordLogin }}"
  sysdigcloud.oauth.allowed.domains.list: "{{ .oauthAllowedDomainsList }}"
  sysdigcloud.google.oauth.client.id: "{{ .googleOauthClientId }}"
  sysdigcloud.google.oauth.client.secret: "{{ .googleOauthClientSecret }}"
  sysdigcloud.ldap.enabled: "{{ .ldapEnabled }}"
  sysdigcloud.ldap.endpoint: "{{ .ldapEndpoint }}"
  sysdigcloud.ldap.manager.dn: "{{ .ldapManagerDn }}"
  sysdigcloud.ldap.manager.password: "{{ .ldapManagerPassword }}"
  sysdigcloud.ldap.root.dn: "{{ .ldapManagerPassword }}"
  sysdigcloud.ldap.user.search.base: "{{ .ldapRootDn }}"
  sysdigcloud.ldap.user.search.filter: "{{ .ldapUserSearchBase }}"
  sysdigcloud.ldap.group.search.base: "{{ .ldapUserSearchFilter }}"
  sysdigcloud.ldap.group.search.filter: "{{ .ldapGroupSearchBase }}"
  sysdigcloud.ldap.group.membership.filter: "{{ .ldapGroupSearchFilter }}"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: sysdigcloud-mysql-config
  namespace: {{ .namespace }}
  labels:
    app: sysdigcloud
data:
  master.cnf: |-
    [client]
    port   = 3306
    socket   = /var/run/mysqld/mysqld.sock
    default-character-set=utf8

    [mysql]
    default-character-set=utf8
    [mysqld_safe]
    pid-file = /var/run/mysqld/mysqld.pid
    socket   = /var/run/mysqld/mysqld.sock
    nice   = 0
    [mysqld]
    user   = mysql
    pid-file = /var/run/mysqld/mysqld.pid
    socket   = /var/run/mysqld/mysqld.sock
    port   = 3306
    basedir    = /usr
    datadir    = /var/lib/mysql
    tmpdir   = /tmp
    lc-messages-dir  = /usr/share/mysql
    explicit_defaults_for_timestamp
    collation-server = utf8_unicode_ci
    init-connect='SET NAMES utf8'
    character-set-server = utf8
    log-error  = /var/log/mysql/error.log
    # Recommended in standard MySQL setup
    sql_mode=NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES
    open_files_limit = 16384
    max_connections = 100000
    # Disabling symbolic-links is recommended to prevent assorted security risks
    symbolic-links=0
    # Replicate to slaves
    log-bin=sdc-mysql-0-bin
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: sysdigcloud-mysql-config-slave
  namespace: {{ .namespace }}
  labels:
    app: sysdigcloud-mysql-slave
data:
  slave.cnf: |-
    [client]
    port   = 3306
    socket   = /var/run/mysqld/mysqld.sock
    default-character-set=utf8

    [mysql]
    default-character-set=utf8
    [mysqld_safe]
    pid-file = /var/run/mysqld/mysqld.pid
    socket   = /var/run/mysqld/mysqld.sock
    nice   = 0
    [mysqld]
    user   = mysql
    pid-file = /var/run/mysqld/mysqld.pid
    socket   = /var/run/mysqld/mysqld.sock
    port   = 3306
    basedir    = /usr
    datadir    = /var/lib/mysql
    tmpdir   = /tmp
    lc-messages-dir  = /usr/share/mysql
    explicit_defaults_for_timestamp
    collation-server = utf8_unicode_ci
    init-connect='SET NAMES utf8'
    character-set-server = utf8
    log-error  = /var/log/mysql/error.log
    # Recommended in standard MySQL setup
    sql_mode=NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES
    open_files_limit = 16384
    max_connections = 100000
    # Disabling symbolic-links is recommended to prevent assorted security risks
    symbolic-links=0
    # Writes from master only
    super-read-only
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: sysdigcloud-redis-config
  namespace: {{ .namespace }}
  labels:
    app: sysdigcloud
    role: redis
data:
  redis.conf: |+
    tcp-backlog 65536
    maxclients 30000
    cluster-enabled no
    cluster-require-full-coverage no
    cluster-node-timeout 15000
    cluster-config-file /data/nodes.conf
    cluster-migration-barrier 1
    appendonly yes
    protected-mode no
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: sysdigcloud-redis-config-slave
  namespace: {{ .namespace }}
  labels:
    app: sysdigcloud
    role: redis-slave
data:
  redis.conf: |+
    tcp-backlog 65536
    maxclients 30000
    cluster-enabled no 
    cluster-require-full-coverage no
    cluster-node-timeout 15000
    cluster-config-file /data/nodes.conf
    cluster-migration-barrier 1
    appendonly yes
    protected-mode no
    slave-serve-stale-data yes
    slaveof sdc-redis-0.sdc-redis 6379
